{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- å¸–å­å¡ç‰‡ -->
    <div class="card mb-4">
        <div class="card-body">
            <!-- å¸–å­å…ƒä¿¡æ¯ -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">
                    <time class="js-time" datetime="{{ post.created_at|iso_utc }}" data-style="datetime">
                        {{ post.created_at|sh_time('%Y-%m-%d %H:%M') }}
                    </time>
                </span>


                <span class="badge bg-secondary">
                    åŒ¿åç”¨æˆ·
                </span>
                <!-- ç®¡ç†å‘˜åˆ é™¤æŒ‰é’® -->
                {% if current_user.is_admin %}
                <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" class="delete-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-sm btn-danger">
                        <i class="bi bi-trash"></i> åˆ é™¤å¸–å­
                    </button>
                </form>
                {% endif %}
            </div>

            <!-- å¸–å­å†…å®¹ -->
            <div class="post-content mb-4">
                {{ post.content }}
            </div>

            <!-- æƒ…ç»ªè¿›åº¦æ¡ -->
            {% if post.get_sentiment() %}
  <div style="margin-top: 16px;">
    <h4>æƒ…ç»ªåˆ†æï¼š</h4>

    {% for label, score in post.get_sentiment().items() %}
      {% set bar_color = "#9e9e9e" %}
      {% set emoji = "ğŸ¤”" %}
      {% if label == "positive" %}
        {% set bar_color = "#4caf50" %}
        {% set emoji = "ğŸ˜„" %}
      {% elif label == "negative" %}
        {% set bar_color = "#f44336" %}
        {% set emoji = "ğŸ˜" %}
      {% endif %}

      <div style="margin-bottom: 10px;">
        <span>{{ emoji }} {{ label|capitalize }}ï¼š</span>
        <div style="background-color: #eee; height: 18px; width: 100%; border-radius: 4px; overflow: hidden;">
          <div style="
              height: 100%;
              width: {{ (score * 100) | round(1) }}%;
              background-color: {{ bar_color }};
              color: white;
              text-align: center;
              font-size: 14px;
          ">
            {{ (score * 100) | round(1) }}%
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}




        </div>
    </div>

    <!-- è¯„è®ºåŒº -->
    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="bi bi-chat-left-text"></i>
                å›åº” ({{ comments|length }})
            </h5>
        </div>
        <div class="card-body">
            {% for comment in comments %}
            <div class="comment-container mb-3" id="comment-{{ comment.id }}">
                <!-- ä¸»è¯„è®º -->
                <div class="card">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">
                                <time class="js-time" datetime="{{ post.created_at|iso_utc }}" data-style="datetime">
                                    {{ post.created_at|sh_time('%Y-%m-%d %H:%M') }}
                                </time>
                            </span>


                            <span class="badge bg-light text-dark">
                                åŒ¿åç”¨æˆ· {{ loop.index }}
                            </span>
                            <!-- ç®¡ç†å‘˜åˆ é™¤è¯„è®ºæŒ‰é’® -->
                            {% if current_user.is_admin %}
                            <form method="POST" action="{{ url_for('delete_comment', comment_id=comment.id) }}" class="delete-form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                        <p class="mt-2 mb-2">{{ comment.content }}</p>

                        <!-- å›å¤æŒ‰é’® -->
                        <button class="btn btn-sm btn-outline-primary reply-btn"
                                data-comment-id="{{ comment.id }}">
                            <i class="bi bi-reply"></i> å›å¤
                        </button>
                    </div>
                </div>

                <!-- å›å¤è¡¨å• (é»˜è®¤éšè—) -->
                <div class="reply-form mt-2 ms-4" style="display:none;">
                    <form method="POST"
                          action="{{ url_for('reply_comment', post_id=post.id, parent_id=comment.id) }}"
                          class="reply-submit-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="input-group mb-3">
                            <textarea class="form-control reply-content" name="content" rows="2" required
                                      placeholder="å†™ä¸‹ä½ çš„å›å¤..."
                                      oninput="debounceCheckReply(this)"></textarea>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>

                        <!-- å›å¤çš„æ•æ„Ÿè¯æ£€æµ‹åé¦ˆ -->
                        <div class="reply-feedback mt-2" style="display: none;">
                            <div class="alert alert-danger reply-sensitive-alert" style="display: none;">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                <span class="reply-sensitive-message"></span>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- æ˜¾ç¤ºå›å¤ -->
                {% if comment.replies %}
                <div class="replies mt-2 ms-4 ps-3 border-start">
                    {% for reply in comment.replies %}
                    <div class="reply mb-2">
                        <div class="card">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">
                                        <time class="js-time" datetime="{{ post.created_at|iso_utc }}" data-style="datetime">
                                            {{ post.created_at|sh_time('%Y-%m-%d %H:%M') }}
                                        </time>
                                    </span>


                                    <span class="badge bg-light text-dark">
                                        åŒ¿åç”¨æˆ· R{{ loop.index }}
                                    </span>
                                </div>
                                <p class="mt-1 mb-0">{{ reply.content }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}

            <!-- æ–°è¯„è®ºè¡¨å• -->
            <div class="mt-4">
                <h6><i class="bi bi-pencil"></i> æ·»åŠ æ–°è¯„è®º</h6>
                <div class="card">
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('add_comment', post_id=post.id) }}" id="commentForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="mb-3">
                                <textarea class="form-control" name="content" rows="3"
                                        placeholder="å†™ä¸‹ä½ çš„å›åº”..." required
                                        oninput="debounceCheckComment()"></textarea>

                                <!-- è¯„è®ºæ•æ„Ÿè¯æ£€æµ‹åé¦ˆ -->
                                <div id="commentFeedback" class="mt-2" style="display: none;">
                                    <div class="alert alert-danger" id="commentSensitiveAlert" style="display: none;">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        <span id="commentSensitiveMessage"></span>
                                    </div>
                                    <div class="alert alert-info" id="commentCheckingAlert" style="display: none;">
                                        <i class="bi bi-hourglass-split"></i> æ­£åœ¨æ£€æŸ¥è¯„è®ºå†…å®¹...
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary" id="commentSubmitBtn">
                                <i class="bi bi-send"></i> æäº¤
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
console.log("ç»‘å®šåˆ é™¤æŒ‰é’®")
//åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
document.addEventListener('submit', function(e) {
    if (e.target.classList.contains('delete-form')) {
        const confirmed = confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼');
        if (!confirmed) {
            e.preventDefault();
            console.log("ç”¨æˆ·å–æ¶ˆåˆ é™¤");
        } else {
            console.log("ç”¨æˆ·ç¡®è®¤åˆ é™¤");
        }
    }
});

// å¯ç”¨Bootstrapå·¥å…·æç¤º
$(function () {
    $('[data-bs-toggle="tooltip"]').tooltip();
});

// å›å¤æŒ‰é’®åŠŸèƒ½
document.querySelectorAll('.reply-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const commentId = this.dataset.commentId;
        const form = this.closest('.comment-container').querySelector('.reply-form');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';

        // è‡ªåŠ¨èšç„¦åˆ°æ–‡æœ¬æ¡†
        if (form.style.display === 'block') {
            form.querySelector('textarea').focus();
        }
    });
});

// è¯„è®ºå†…å®¹æ£€æµ‹
let commentDebounceTimer = null;

function debounceCheckComment() {
    clearTimeout(commentDebounceTimer);
    commentDebounceTimer = setTimeout(() => {
        checkCommentContent();
    }, 800);
}

async function checkCommentContent() {
    const content = $('#commentForm textarea').val().trim();
    if (!content) {
        $('#commentFeedback').hide();
        return;
    }

    $('#commentCheckingAlert').show();
    $('#commentSensitiveAlert').hide();
    $('#commentFeedback').show();

    try {
        const response = await fetch('/api/content/check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ content: content })
        });

        const result = await response.json();

        if (result.is_sensitive) {
            $('#commentSensitiveMessage').text(result.message);
            if (result.details) {
                const details = Object.entries(result.details).map(
                    ([cat, words]) => `${cat}: ${words.slice(0,3).join(',')}${words.length>3?'...':''}`
                ).join('; ');
                $('#commentSensitiveMessage').text($('#commentSensitiveMessage').text() + ` (${details})`);
            }
            $('#commentCheckingAlert').hide();
            $('#commentSensitiveAlert').show();
        } else {
            $('#commentFeedback').hide();
        }
    } catch (error) {
        console.error('è¯„è®ºæ£€æµ‹å¤±è´¥:', error);
        $('#commentSensitiveMessage').text('å†…å®¹å®‰å…¨æ£€æŸ¥æš‚æ—¶ä¸å¯ç”¨');
        $('#commentCheckingAlert').hide();
        $('#commentSensitiveAlert').show();
    }
}

// å›å¤å†…å®¹æ£€æµ‹
function debounceCheckReply(textarea) {
    const form = $(textarea).closest('.reply-submit-form');
    clearTimeout(form.data('debounce'));
    form.data('debounce', setTimeout(() => {
        checkReplyContent(form);
    }, 800));
}

async function checkReplyContent(form) {
    const content = form.find('.reply-content').val().trim();
    const feedback = form.find('.reply-feedback');

    if (!content) {
        feedback.hide();
        return;
    }

    feedback.find('.reply-sensitive-alert').hide();
    feedback.show();

    try {
        const response = await fetch('/api/content/check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ content: content })
        });

        const result = await response.json();

        if (result.is_sensitive) {
            let message = result.message || 'æ£€æµ‹åˆ°æ•æ„Ÿå†…å®¹';
            if (result.details) {
                const details = Object.entries(result.details).map(
                    ([cat, words]) => `${cat}: ${words.slice(0,2).join(',')}${words.length>2?'...':''}`
                ).join('; ');
                message += ` (${details})`;
            }
            form.find('.reply-sensitive-message').text(message);
            feedback.find('.reply-sensitive-alert').show();
        } else {
            feedback.hide();
        }
    } catch (error) {
        console.error('å›å¤æ£€æµ‹å¤±è´¥:', error);
        form.find('.reply-sensitive-message').text('å†…å®¹å®‰å…¨æ£€æŸ¥æš‚æ—¶ä¸å¯ç”¨');
        feedback.find('.reply-sensitive-alert').show();
    }
}

// é˜»æ­¢åŒ…å«æ•æ„Ÿå†…å®¹çš„æäº¤
$('#commentForm').on('submit', function(e) {
    if ($('#commentSensitiveAlert').is(':visible')) {
        e.preventDefault();
        $('#commentSensitiveAlert').addClass('animate__animated animate__headShake');
        setTimeout(() => {
            $('#commentSensitiveAlert').removeClass('animate__animated animate__headShake');
        }, 1000);
    }
});

$('.reply-submit-form').on('submit', function(e) {
    if ($(this).find('.reply-sensitive-alert').is(':visible')) {
        e.preventDefault();
        $(this).find('.reply-sensitive-alert').addClass('animate__animated animate__headShake');
        setTimeout(() => {
            $(this).find('.reply-sensitive-alert').removeClass('animate__animated animate__headShake');
        }, 1000);
    }
});

// æš—é»‘æ¨¡å¼é€‚é…
if (document.body.classList.contains('dark-mode')) {
    document.querySelectorAll('.card').forEach(card => {
        card.classList.add('bg-dark');
        card.classList.add('text-light');
    });
}
</script>

<style>
.comment-container {
    position: relative;
}
.replies {
    border-left: 3px solid #dee2e6;
}
.dark-mode .replies {
    border-left-color: #495057;
}
.reply-form textarea {
    resize: none;
}

/* åŠ¨ç”»æ•ˆæœ */
.animate__animated {
    animation-duration: 1s;
}
.animate__headShake {
    animation-name: headShake;
}
@keyframes headShake {
    0% { transform: translateX(0); }
    20% { transform: translateX(-6px); }
    40% { transform: translateX(5px); }
    60% { transform: translateX(-4px); }
    80% { transform: translateX(3px); }
    100% { transform: translateX(0); }
}

/* æš—é»‘æ¨¡å¼é€‚é… */
.dark-mode #commentSensitiveAlert,
.dark-mode .reply-sensitive-alert {
    background-color: #4a1c1c;
    border-color: #842029;
}
.dark-mode #commentCheckingAlert {
    background-color: #1c2b4a;
    border-color: #084298;
}
.dark-mode .reply-feedback {
    color: #f8f9fa;
}
</style>
{% endblock %}